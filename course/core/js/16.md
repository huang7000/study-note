# 第 16 章 DOM2 和 DOM3

## DOM 的演进

:::code DOM 的演进

- DOM Core：在 DOM1 核心部分的基础上，为节点增加方法和属性。
- DOM Views：定义基于样式信息的不同视图。
- DOM Events：定义通过事件实现 DOM 文档交互。
- DOM Style：定义以编程方式访问和修改 CSS 样式的接口。
- DOM Traversal and Range：新增遍历 DOM 文档及选择文档内容的接口。
- DOM HTML：在 DOM1 HTML 部分的基础上，增加属性、方法和新接口。
- DOM Mutation Observers：定义基于 DOM 变化触发回调的接口。这个模块是 DOM4 级模块，用于取代 Mutation Events。

```js
```

:::

:::code XML 命名空间

在 DOM2 中，Node 类型包含以下特定于命名空间的属性：

- localName，不包含命名空间前缀的节点名；
- namespaceURI，节点的命名空间 URL，如果未指定则为 null；
- prefix，命名空间前缀，如果未指定则为 null。

DOM3 进一步增加了如下与命名空间相关的方法：

- isDefaultNamespace(namespaceURI)，返回布尔值，表示 namespaceURI 是否为节点的默认命名空间；
- lookupNamespaceURI(prefix)，返回给定 prefix 的命名空间 URI；
- lookupPrefix(namespaceURI)，返回给定 namespaceURI 的前缀。

DOM2 在 Document 类型上新增了如下命名空间特定的方法：

- createElementNS(namespaceURI, tagName)，以给定的标签名 tagName 创建指定命名空间 namespaceURI 的一个新元素；
- createAttributeNS(namespaceURI, attributeName)，以给定的属性名 attributeName创建指定命名空间 namespaceURI 的一个新属性；
- getElementsByTagNameNS(namespaceURI, tagName)，返回指定命名空间 namespaceURI中所有标签名为 tagName 的元素的 NodeList。

DOM2 Core 对 Element 类型的更新主要集中在对属性的操作上。下面是新增的方法：

- getAttributeNS(namespaceURI, localName)，取得指定命名空间 namespaceURI 中名为localName 的属性；
- getAttributeNodeNS(namespaceURI, localName)，取得指定命名空间 namespaceURI 中名为 localName 的属性节点；
- getElementsByTagNameNS(namespaceURI, tagName)，取得指定命名空间 namespaceURI中标签名为 tagName 的元素的 NodeList；
- hasAttributeNS(namespaceURI, localName)，返回布尔值，表示元素中是否有命名空间namespaceURI 下名为 localName 的属性；
- removeAttributeNS(namespaceURI, localName)，删除指定命名空间 namespaceURI 中名为 localName 的属性；
- setAttributeNS(namespaceURI, qualifiedName, value)，设置指定命名空间 namespaceURI中名为 qualifiedName 的属性为 value； 
- setAttributeNodeNS(attNode)，为元素设置（添加）包含命名空间信息的属性节点 attNode。

NamedNodeMap 也增加了以下处理命名空间的方法。因为 NamedNodeMap 主要表示属性，所以这些方法大都适用于属性：

- getNamedItemNS(namespaceURI, localName)，取得指定命名空间 namespaceURI 中名为localName 的项；
- removeNamedItemNS(namespaceURI, localName)，删除指定命名空间 namespaceURI 中名为 localName 的项；
- setNamedItemNS(node)，为元素设置（添加）包含命名空间信息的节点。

:::

:::code XMLHTML

```xml
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Example XHTML page</title>
</head>

<body>
  <svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 100" style="width:100%; height:100%">
    <rect x="0" y="0" width="100" height="100" style="fill:red" />
  </svg>
</body>
<script>
  console.log(document.body.isDefaultNamespace("http://www.w3.org/1999/ xhtml")); // true 
  // 假设 svg 包含对<s:svg>元素的引用
  // console.log(svg.lookupPrefix("http://www.w3.org/2000/svg")); // "s" 
  // console.log(svg.lookupNamespaceURI("s")); // "http://www.w3.org/2000/svg"
  // 创建一个新 SVG 元素
  let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  // 创建一个任意命名空间的新属性
  let att = document.createAttributeNS("http://www.somewhere.com", "random");
  // 获取所有 XHTML 元素
  let elems = document.getElementsByTagNameNS("http://www.w3.org/1999/xhtml", "*");
</script>

</html>
```

:::

:::code 其他变化
DocumentType 新增了 3 个属性：publicId、systemId 和 internalSubset。
publicId、systemId 属性表示文档类型声明中有效但无法使用 DOM1 API 访问的数据。
Document 类型的更新中唯一跟命名空间无关的方法是 importNode()。这个方法的目的是从其他文档获取一个节点并导入到新文档，以便将其插入新文档。

createDocumentType()用于创建 DocumentType 类型的新节点，接收 3 个参数：文档类型名称、publicId 和 systemId。
创建新文档要使用 createDocument()方法。createDocument()接 收 3 个参数：文档元素的namespaceURI、文档元素的标签名和文档类型。
createHTMLDocument()方法。使用这个方法可以创建一个完整的 HTML 文档，包含`<html>`、`<head>`、`<title>`和`<body>`元素。

```html
<!DOCTYPE HTML PUBLIC "-// W3C// DTD HTML 4.01// EN" "http://www.w3.org/TR/html4/strict.dtd">
[<!ELEMENT name (#PCDATA)>] >
<html>
<body>
</body>
<script>
  console.log(document.doctype.publicId); //"-// W3C// DTD HTML 4.01// EN"
  console.log(document.doctype.systemId);//"http://www.w3.org/TR/ html4/strict.dtd"
  console.log(document.doctype.internalSubset);//"[<!ELEMENT name (#PCDATA)>] >"

  let newNode = document.importNode(oldNode, true); // 导入节点及所有后代
  document.body.appendChild(newNode);

  let doctype = document.implementation.createDocumentType("html",
    "-// W3C// DTD XHTML 1.0 Strict// EN",
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd");
  let doc = document.implementation.createDocument("http://www.w3.org/1999/xhtml",
    "html", doctype);
  let htmldoc = document.implementation.createHTMLDocument("New Doc");
  console.log(htmldoc.title); // "New Doc" 
  console.log(typeof htmldoc.body); // "object"
</script>

</html>
```

:::

:::code 样式
DOM3 新增了两个用于比较节点的方法：isSameNode()和 isEqualNode()。
这两个方法都接收一个节点参数，如果这个节点与参考节点相同或相等，则返回 true。
节点相同，意味着引用同一个对象；节点相等，意味着节点类型相同，拥有相等的属性（nodeName、nodeValue 等），而且 attributes和 childNodes 也相等（即同样的位置包含相等的值）。

DOM3 也增加了给 DOM 节点附加额外数据的方法。setUserData()方法接收 3 个参数：键、值、处理函数，用于给节点追加数据。

DOM2 HTML 给 HTMLIFrameElement（即`<iframe>`，内嵌窗格）类型新增了一个属性，叫contentDocument。这个属性包含代表子内嵌窗格中内容的 document 对象的指针。

```js
let div1 = document.createElement("div");
div1.setAttribute("class", "box");
let div2 = document.createElement("div");
div2.setAttribute("class", "box");
console.log(div1.isSameNode(div1)); // true 
console.log(div1.isEqualNode(div2)); // true 
console.log(div1.isSameNode(div2)); // false
let div = document.createElement("div");
div.setUserData("name", "Nicholas", function (operation, key, value, src, dest) {
  if (operation == 1) {
    dest.setUserData(key, value, function () { });
  }
});
let newDiv = div.cloneNode(true);
console.log(newDiv.getUserData("name")); // "Nicholas"

let iframe = document.getElementById("myIframe"); 
let iframeDoc = iframe.contentDocument;
```

:::

## 样式

:::code 样式

```js
```

:::

:::code 存取元素样式

```js
```

:::

:::code 操作样式表

```js
```

:::

:::code 元素尺寸

```js
```

:::

## 遍历

:::code 遍历

```js
```

:::

:::code NodeIterator

```js
```

:::

:::code TreeWalker

```js
```

:::

## 范围

:::code 范围

```js
```

:::

:::code DOM 范围

```js
```

:::

:::code 简单选择

```js
```

:::

:::code 复杂选择

```js
```

:::

:::code 操作范围

```js
```

:::

:::code 范围插入

```js
```

:::

:::code 范围折叠

```js
```

:::

:::code 范围比较

```js
```

:::

:::code 复制范围

```js
```

:::

:::code 清理

```js
```

:::
