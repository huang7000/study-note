# 第 14 章 DOM

## 节点层级

:::code 节点层级

文档对象模型（DOM，Document Object Model）是 HTML 和 XML 文档的编程接口。
DOM 表示由多层节点构成的文档，通过它开发者可以添加、删除和修改页面的各个部分。
DOM Level 1 在 1998 年成为 W3C 推荐标准，提供了基本文档结构和查询的接口。

任何 HTML 或 XML 文档都可以用 DOM 表示为一个由节点构成的层级结构。
节点分很多类型，每种类型对应着文档中不同的信息和（或）标记，也都有自己不同的特性、数据和方法，而且与其他类型有某种关系。
这些关系构成了层级，让标记可以表示为一个以特定节点为根的树形结构。

根节点的唯一子节点是`<html>`元素，我们称之为文档元素（documentElement）。
文档元素是文档最外层的元素，所有其他元素都存在于这个元素之内。每个文档只能有一个文档元素。

在 HTML 页面中，文档元素始终是`<html>`元素。
在 XML 文档中，则没有这样预定义的元素，任何元素都可能成为文档元素。

HTML 中的每段标记都可以表示为这个树形结构中的一个节点。
元素节点表示 HTML 元素，属性节点表示属性，文档类型节点表示文档类型，注释节点表示注释。
DOM 中总共有 12 种节点类型，这些类型都继承一种基本类型: Node 类型。

```html
<html> 
 <head> 
 <title>Sample Page</title> 
 </head> 
 <body> 
 <p>Hello World!</p> 
 </body> 
</html>
```

:::

:::code Node 类型

DOM Level 1 描述了名为 Node 的接口，这个接口是所有 DOM 节点类型都必须实现的。
Node 接口在 JavaScript中被实现为 Node 类型，在除 IE之外的所有浏览器中都可以直接访问这个类型。
在 JavaScript中，所有节点类型都继承 Node 类型，因此所有类型都共享相同的基本属性和方法。
浏览器并不支持所有节点类型。

每个节点都有 nodeType 属性，表示该节点的类型。节点类型由定义在 Node 类型上的 12 个数值常量表示：

- Node.ELEMENT_NODE（1）
- Node.ATTRIBUTE_NODE（2）
- Node.TEXT_NODE（3）
- Node.CDATA_SECTION_NODE（4）
- Node.ENTITY_REFERENCE_NODE（5）
- Node.ENTITY_NODE（6）
- Node.PROCESSING_INSTRUCTION_NODE（7）
- Node.COMMENT_NODE（8）
- Node.DOCUMENT_NODE（9）
- Node.DOCUMENT_TYPE_NODE（10）
- Node.DOCUMENT_FRAGMENT_NODE（11）
- Node.NOTATION_NODE（12）

:::

:::code Node 类型

DOM Level 1 描述了名为 Node 的接口，这个接口是所有 DOM 节点类型都必须实现的。
Node 接口在 JavaScript中被实现为 Node 类型，在除 IE之外的所有浏览器中都可以直接访问这个类型。
在 JavaScript中，所有节点类型都继承 Node 类型，因此所有类型都共享相同的基本属性和方法。
浏览器并不支持所有节点类型。

每个节点都有 nodeType 属性，表示该节点的类型。节点类型由定义在 Node 类型上的 12 个数值常量表示：

- Node.ELEMENT_NODE（1）
- Node.ATTRIBUTE_NODE（2）
- Node.TEXT_NODE（3）
- Node.CDATA_SECTION_NODE（4）
- Node.ENTITY_REFERENCE_NODE（5）
- Node.ENTITY_NODE（6）
- Node.PROCESSING_INSTRUCTION_NODE（7）
- Node.COMMENT_NODE（8）
- Node.DOCUMENT_NODE（9）
- Node.DOCUMENT_TYPE_NODE（10）
- Node.DOCUMENT_FRAGMENT_NODE（11）
- Node.NOTATION_NODE（12）

:::

:::code Node 节点关系

```html
<!DOCTYPE html>
<html>
<body>
  <h1>JavaScript Demo</h1>
  <div>
    <p id="counter">
      <button id="start">Start</button>
      <button id="cancel">Cancel</button>
    </p>
  </div>

  <script>
    let someNode = document.getElementById("counter")
    console.log(someNode);
    //nodeName 与 nodeValue 保存着有关节点的信息。这两个属性的值完全取决于节点类型。
    console.log(someNode.nodeType) //1 Node.ELEMENT_NODE
    console.log(someNode.nodeName) // DIV
    console.log(someNode.nodeValue) //null
    //节点类型可通过与这些常量比较来确定
    if (someNode.nodeType == Node.ELEMENT_NODE) {
      console.log("Node is an ELEMENT_NODE.");
    }
    //节点关系 
    // 每个节点都有一个 childNodes 属性，其中包含一个 NodeList 的实例。NodeList 是一个类数组对象，用于存储可以按位置存取的有序节点。
    console.log(someNode.childNodes.length); //5
    console.log(someNode.childNodes[1]); //<button id="start">Start</button>
    console.log(Array.from(someNode.childNodes)); //[text, button#start, text, button#cancel, text]

    //使用 previousSibling 和 nextSibling 可以在这个列表的节点间导航
    console.log(someNode.nextSibling); //#text
    console.log(someNode.previousSibling); //#text
    console.log(someNode.firstChild); //#text
    console.log(someNode.lastChild); //#text
    //ownerDocument 属性是一个指向代表整个文档的文档节点的指针。
    console.log(someNode.ownerDocument); //#document
    //每个节点都有一个 parentNode 属性，指向其 DOM 树中的父元素。
    console.log(someNode.parentNode); //<div>...</div>
  </script>
</body>
</html>
```

:::

:::code Node 方法

```js
let someNode = document.getElementById("counter")
console.log(someNode);
//appendChild()，用于在 childNodes 列表末尾添加节点。添加新节点会更新相关的关系指针，包括父节点和之前的最后一个子节点。appendChild()方法返回新添加的节点
var newNode = document.createElement('p')
newNode.textContent = '段落2'
let returnedNode = someNode.appendChild(newNode);
console.log(returnedNode == newNode); // true 
console.log(someNode.lastChild == newNode); // true
//如果把文档中已经存在的节点传给 appendChild()，则这个节点会从之前的位置被转移到新位置。
returnedNode = someNode.appendChild(someNode.firstChild);
console.log(returnedNode == someNode.firstChild); // false 
console.log(returnedNode == someNode.lastChild); // true
//如果想把节点放到 childNodes 中的特定位置而不是末尾，则可以使用 insertBefore()方法。两参数 要插入的节点和参照节点。
// 作为最后一个子节点插入
returnedNode = someNode.insertBefore(newNode, null);
console.log(newNode == someNode.lastChild); // true 
// 作为新的第一个子节点插入
returnedNode = someNode.insertBefore(newNode, someNode.firstChild);
console.log(returnedNode == newNode); // true 
console.log(newNode == someNode.firstChild); // true 
// 插入最后一个子节点前面
returnedNode = someNode.insertBefore(newNode, someNode.lastChild);
console.log(newNode == someNode.childNodes[someNode.childNodes.length - 2]); // true
//replaceChild()方法接收两个参数：要插入的节点和要替换的节点。要替换的节点会被返回并从文档树中完全移除，要插入的节点会取而代之。
// 替换第一个子节点
returnedNode = someNode.replaceChild(newNode, someNode.firstChild);
// 替换最后一个子节点
returnedNode = someNode.replaceChild(newNode, someNode.lastChild);
//removeChild()方法。这个方法接收一个参数，即要移除的节点。被移除的节点会被返回
// 删除第一个子节点
let formerFirstChild = someNode.removeChild(someNode.firstChild);
// 删除最后一个子节点
let formerLastChild = someNode.removeChild(someNode.lastChild);
//cloneNode()，会返回与调用它的节点一模一样的节点。cloneNode()方法接收一个布尔值参数，表示是否深复制。
let deepList = someNode.cloneNode(true);
console.log(deepList.childNodes.length); // 2
let shallowList = someNode.cloneNode(false);
console.log(shallowList.childNodes.length); // 0
//normalize()。这个方法唯一的任务就是处理文档子树中的文本节点。
console.log(someNode.childNodes.length); //2
someNode.normalize()
console.log(someNode.childNodes.length); //2
```

:::

:::code Document 类型

Document 类型是 JavaScript 中表示文档节点的类型。
在浏览器中，文档对象 document 是HTMLDocument 的实例（HTMLDocument 继承 Document），表示整个 HTML 页面。

Document 类型的节点有以下特征：

- nodeType 等于 9；
- nodeName 值为"#document"；
- nodeValue 值为 null；
- parentNode 值为 null；
- ownerDocument 值为 null；
- 子节点可以是 DocumentType（最多一个）、Element（最多一个）、ProcessingInstruction或 Comment 类型。

文档类型（如果存在）是只读的，而且只能有一个 Element 类型的子节点（即`<html>`，已经存在了）。
appendChild()、removeChild()和 replaceChild()方法不会用在 document 对象上。

```js
//文档子节点
let html = document.documentElement; // 取得对<html>的引用
let body = document.body; // 取得对<body>的引用
let doctype = document.doctype; // 取得对<!doctype>的引用

//文档信息
let title = document.title;
let url = document.URL; // 取得完整的 URL 
let domain = document.domain; // 取得域名
let referrer = document.referrer;// 取得来源
//在这些属性中，只有 domain 属性是可以设置的。出于安全考虑，给 domain 属性设置的值是有限。
//不能给 domain 设置 URL 中不包含的值
// 页面来自 p2p.wrox.com 
document.domain = "wrox.com"; // 成功
document.domain = "nczonline.net"; // 出错！
//浏览器对 domain 属性还有一个限制，即这个属性一旦放松就不能再收紧。
 // 页面来自 p2p.wrox.com 
document.domain = "wrox.com"; // 放松，成功
document.domain = "p2p.wrox.com"; // 收紧，错误！
```

:::

:::code  Document 定位元素

- getElementById()方法接收一个参数，即要获取元素的 ID，如果找到了则返回这个元素，如果没找到则返回 null。
- getElementsByTagName()是另一个常用来获取元素引用的方法。这个方法接收一个参数，即要获取元素的标签名，返回包含零个或多个元素的NodeList。
- getElementsByName()方法会返回具有给定 name 属性的所有元素。getElementsByName()方法最常用于单选按钮。

```html
<div id="myDiv" name="myDiv">Some text</div>
<script>
  let someNode = document.getElementById("counter");
  let myDivId = document.getElementById("myDiv");
  let myDivName = document.getElementsByName("myDiv");
  let myDivTagName = document.getElementsByTagName("div");
  console.log(myDivId);//Node
  console.log(myDivTagName);//HTMLCollection
  console.log(myDivName);//NodeList
  console.log(myDivName == myDivTagName);//false
  console.log(myDivName[0] == myDivId);//true
  console.log(myDivTagName[0] == myDivId);//true
</script>
```

:::

:::code  Document 文档写入

write()和 writeln()方法都接收一个字符串参数，可以将这个字符串写入网页中。
write()简单地写入文本，而 writeln()还会在字符串末尾追加一个换行符（\n）。
open()和 close()方法分别用于打开和关闭网页输出流。
write()和 writeln()方法经常用于动态包含外部资源，如 JavaScript 文件。

```js
document.write("<script type=\"text/javascript\" src=\"file.js\"><\/script>");
```

:::

:::code  Document 特殊集合

document 对象上还暴露了几个特殊集合，这些集合也都是 HTMLCollection 的实例。这些集合是
访问文档中公共部分的快捷方式，列举如下。

- document.anchors 包含文档中所有带 name 属性的`<a>`元素。
- document.forms 包含文档中所有`<form>`元素（与 document.getElementsByTagName ("form")返回的结果相同）。
- document.images 包含文档中所有`<img>`元素（与 document.getElementsByTagName ("img")返回的结果相同）。
- document.links 包含文档中所有带 href 属性的`<a>`元素。

:::

:::code Element 类型

```js
```

:::

:::code Text 类型

```js
```

:::

:::code Comment 类型

```js
```

:::

:::code CDATASection 类型

```js
```

:::

:::code DocumentType 类型

```js
```

:::

:::code DocumentFragment 类型

```js
```

:::

:::code Attr 类型

```js
```

:::

## DOM 编程

:::code 动态脚本

```js
```

:::

:::code 动态样式

```js
```

:::

:::code 操作表格

```js
```

:::

:::code 使用 NodeList

```js
```

:::

## MutationObserver 接口

:::code 基本用法

```js
```

:::

:::code MutationObserverInit 与观察范围

```js
```

:::

:::code 异步回调与记录队列

```js
```

:::

:::code 性能、内存与垃圾回收

```js
```

:::
